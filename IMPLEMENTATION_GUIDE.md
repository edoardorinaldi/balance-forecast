# Balance Forecast - Implementation Guide

This document provides a comprehensive guide to the React implementation of the Balance Forecast application.

## Overview

This project is a faithful port of the Python Streamlit prototype to a modern React + TypeScript application deployed on Vercel with Supabase as the backend.

## Architecture

### Component Structure

```
App (Main Component)
├── Header (Logo and Title)
├── Main Content Area
│   ├── AddTransactionForm
│   │   └── Form for adding new transactions
│   ├── TransactionList
│   │   ├── Table of future transactions
│   │   └── Edit/Delete controls
│   ├── ForecastSettings
│   │   ├── Starting Balance input
│   │   └── Forecast Period slider
│   ├── ForecastChart (Recharts LineChart)
│   │   └── Visualization of balance over time
│   └── SummaryStatistics
│       └── Key metrics display
└── Footer
```

### Data Flow

1. **Load Data**: App mounts → useTransactions hook fetches transactions from Supabase
2. **User Input**: User adds/edits/deletes transactions
3. **Database Update**: Transaction persisted to Supabase
4. **State Update**: Local state updated, components re-render
5. **Forecast Calculation**: Balance calculation triggered automatically
6. **Chart Update**: Chart displays new forecast data

## Key Business Logic

### Occurrence Generation
File: `src/lib/forecast.ts` → `generateOccurrenceDates()`

Generates all dates when a transaction occurs between start and end dates.

**Algorithm:**
```
current_date = start_date
while current_date <= end_date:
    add current_date to dates
    if frequency == 0: break
    current_date += delta(frequency, uom)
return dates
```

### Future Occurrence Check
File: `src/lib/forecast.ts` → `hasFutureOccurrence()`

Efficiently determines (O(1)) if a transaction has future occurrences without generating all dates.

**Algorithm:**
```
if end_date < today: return false
if start_date >= today: return true
if frequency == 0: return false
current = start_date
while current < today:
    current += delta(frequency, uom)
return current <= end_date
```

### Cash Flow Calculation
File: `src/lib/forecast.ts` → `calculateCashFlow()`

Sums amounts of all transactions occurring on a specific date.

**Algorithm:**
```
sum = 0
for each transaction:
    if date in generateOccurrenceDates(transaction):
        sum += transaction.amount
return sum
```

### Balance Calculation
File: `src/lib/forecast.ts` → `calculateResults()`

Computes daily balances over forecast period.

**Algorithm:**
```
balance = starting_balance
for each date from start to end:
    cash_flow = calculateCashFlow(date)
    balance = balance + cash_flow
    store (date, cash_flow, balance)
return results
```

## Component Details

### AddTransactionForm
- **Props**: `onAdd` (callback), `isLoading` (boolean)
- **State**: Form fields, error/success messages
- **Validation**: All fields required before submission
- **Behavior**: Resets form after successful submission

### TransactionList
- **Props**: `transactions`, `onDelete`, `onEdit`, `isLoading`
- **State**: Current edit mode (id, field, value)
- **Features**:
  - Inline editing
  - Delete buttons
  - Sort by ID (server-side)
  - Responsive table layout

### ForecastChart
- **Props**: `data` (CalculationResult[])
- **Library**: Recharts
- **Features**:
  - Line chart of balance over time
  - Reference line at y=0
  - Grid, axis labels, tooltip
  - Responsive sizing

## Database Schema

### Transactions Table

```sql
CREATE TABLE transactions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  amount NUMERIC NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  frequency INTEGER NOT NULL DEFAULT 1,
  uom TEXT NOT NULL CHECK (uom IN ('day', 'week', 'month')),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### Indexes

```sql
CREATE INDEX idx_transactions_future 
ON transactions(end_date, start_date) 
WHERE end_date >= CURRENT_DATE;
```

## Deployment

### Vercel Deployment

1. **Environment Variables**:
   - `VITE_SUPABASE_URL`
   - `VITE_SUPABASE_ANON_KEY`

2. **Build Command**: `npm run build`
3. **Output Directory**: `dist`

### Configuration Files

- **vercel.json**: Deployment configuration
- **.env.local**: Local development secrets
- **.env.example**: Template for environment variables

## Performance Optimizations

1. **Memoization**: Components use React.memo for expensive calculations
2. **Lazy Loading**: Chart data calculated only when displayed
3. **Type Safety**: TypeScript prevents runtime errors
4. **CSS Variables**: Efficient styling with custom properties
5. **Grid Layout**: CSS Grid for responsive design

## Testing

### Manual Testing Checklist

- [ ] Add transaction with various frequencies
- [ ] Edit transaction (amount, dates, frequency)
- [ ] Delete transaction
- [ ] Verify only future transactions shown
- [ ] Forecast calculation accuracy
- [ ] Chart rendering
- [ ] Responsive design on mobile
- [ ] Error handling (invalid inputs)
- [ ] Empty state (no transactions)

### Edge Cases

1. **One-time transaction** (frequency = 0)
2. **Transaction ending today** (end_date = today)
3. **Transaction starting in future** (start_date > today)
4. **Negative amounts** (expenses)
5. **Large forecast periods** (12 months)
6. **Many transactions** (performance)

## Troubleshooting

### Common Issues

**Issue**: Transactions not loading
- **Solution**: Check Supabase URL and anon key in .env.local
- **Check**: Network tab in browser DevTools

**Issue**: Chart not displaying
- **Solution**: Ensure Recharts is installed (`npm install recharts`)
- **Check**: Browser console for errors

**Issue**: Forecast values incorrect
- **Solution**: Verify date parsing and calculation logic
- **Check**: Start with simple transactions first

**Issue**: Build failures
- **Solution**: Ensure Node.js 18+ is installed
- **Check**: `node --version`

## Code Style

- **TypeScript**: Strict mode enabled
- **React**: Functional components with hooks
- **CSS**: Custom properties, BEM naming
- **File Structure**: Organized by feature/type

## Dependencies

### Production
- **react**: UI library
- **react-dom**: DOM rendering
- **@supabase/supabase-js**: Backend-as-a-service
- **recharts**: Charting library
- **date-fns**: Date manipulation

### Development
- **vite**: Build tool
- **typescript**: Type safety
- **eslint**: Code quality

## Future Enhancements

1. **Multi-user Support**: User authentication
2. **Data Export**: CSV/PDF reports
3. **Advanced Forecasting**: Scenarios and what-if analysis
4. **Categories**: Transaction categorization
5. **Graphs**: Additional visualization types
6. **Dark Mode**: Theme switching
7. **Offline Mode**: Service worker caching
8. **Mobile App**: React Native version

## Security

- **Row Level Security**: Supabase RLS policies
- **Environment Secrets**: Never commit .env files
- **Input Validation**: Server and client-side
- **HTTPS Only**: Enforced in production

## Maintenance

### Regular Tasks

1. **Dependencies**: Update monthly with `npm update`
2. **Security**: Run `npm audit` weekly
3. **Monitoring**: Check Vercel dashboard for errors
4. **Database**: Monitor Supabase query performance

### Database Migrations

Supabase provides a migration system. Use:
```sql
-- Create migration
CREATE TABLE transactions_v2 AS SELECT * FROM transactions;

-- Swap tables
ALTER TABLE transactions RENAME TO transactions_old;
ALTER TABLE transactions_v2 RENAME TO transactions;
```

## Support

For issues:
1. Check browser console for errors
2. Verify .env.local configuration
3. Check Supabase dashboard for data
4. Review application logs in Vercel

## Version History

- **v1.0.0**: Initial release
  - CRUD operations for transactions
  - Balance forecasting with daily calculations
  - Interactive Recharts visualization
  - Responsive design
  - Vercel deployment ready

## License

MIT License - See LICENSE file for details
