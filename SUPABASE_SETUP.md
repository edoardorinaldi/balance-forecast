# Supabase Setup Guide

This guide provides step-by-step instructions to set up the Supabase backend for the Balance Forecast application.

## Prerequisites

- Supabase account (free tier available at [supabase.com](https://supabase.com))
- PostgreSQL basic knowledge (helpful but not required)

## Step 1: Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Click "Start your project"
3. Sign in with GitHub or email
4. Click "New Project"
5. Fill in project details:
   - **Name**: `balance-forecast` (or your preference)
   - **Database Password**: Generate strong password (save it!)
   - **Region**: Choose closest to you
   - **Pricing**: Select "Free" tier
6. Click "Create new project"
7. Wait 1-2 minutes for database to spin up

## Step 2: Create Transactions Table

1. In Supabase dashboard, go to "SQL Editor"
2. Click "New Query"
3. Copy and paste this SQL:

```sql
-- Create transactions table
CREATE TABLE transactions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  amount NUMERIC NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  frequency INTEGER NOT NULL DEFAULT 1,
  uom TEXT NOT NULL CHECK (uom IN ('day', 'week', 'month')),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Create index for faster queries
CREATE INDEX idx_transactions_end_date 
ON transactions(end_date) 
WHERE end_date >= CURRENT_DATE;

-- Create updated_at trigger
CREATE TRIGGER update_transactions_updated_at
BEFORE UPDATE ON transactions
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

4. Click "Run"
5. Should see success message

## Step 3: Set Up Row Level Security (RLS)

### For Development (Public Access)

```sql
-- Enable RLS
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Allow all operations
CREATE POLICY "Allow all operations" ON transactions
  FOR ALL
  USING (true)
  WITH CHECK (true);
```

### For Production (User-Specific Access)

1. First, add user_id column:
```sql
ALTER TABLE transactions ADD COLUMN user_id UUID REFERENCES auth.users(id);
```

2. Create RLS policies:
```sql
-- Enable RLS
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Users can read their own transactions
CREATE POLICY "Users can read own transactions"
  ON transactions
  FOR SELECT
  USING (auth.uid() = user_id);

-- Users can insert their own transactions
CREATE POLICY "Users can insert own transactions"
  ON transactions
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Users can update their own transactions
CREATE POLICY "Users can update own transactions"
  ON transactions
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Users can delete their own transactions
CREATE POLICY "Users can delete own transactions"
  ON transactions
  FOR DELETE
  USING (auth.uid() = user_id);
```

## Step 4: Get API Credentials

1. In Supabase dashboard, go to "Settings" (bottom of sidebar)
2. Click "API"
3. Copy these values:
   - **Project URL**: `https://[project-id].supabase.co`
   - **Anon Key**: Long alphanumeric string
   - **Service Role Key**: Save securely (never share)

## Step 5: Update Application Configuration

1. In your React project, edit `.env.local`:

```
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
```

2. Replace `your-project-id` and `your-anon-key-here` with values from Step 4

## Step 6: Test Connection

1. Start the development server:
```bash
npm run dev
```

2. Open browser to `http://localhost:5173`

3. Add a test transaction:
   - Name: "Test Income"
   - Amount: 1000
   - Start Date: Today
   - End Date: End of month
   - Frequency: 1
   - UoM: Month

4. Check Supabase:
   - Go to "Table Editor"
   - Click "transactions"
   - Should see your test transaction

## Sample Data

To test your app, add some sample transactions:

```sql
INSERT INTO transactions (name, amount, start_date, end_date, frequency, uom) VALUES
('Monthly Salary', 3000, '2026-01-01', '2026-12-31', 1, 'month'),
('Rent', -1200, '2026-01-01', '2026-12-31', 1, 'month'),
('Groceries', -300, '2026-01-05', '2026-12-31', 2, 'week'),
('Utilities', -150, '2026-01-10', '2026-12-31', 1, 'month'),
('Gym', -50, '2026-01-01', '2026-12-31', 1, 'month'),
('Bonus', 500, '2026-06-30', '2026-06-30', 0, 'month'),
('Car Payment', -250, '2026-01-05', '2026-12-31', 1, 'month');
```

Execute in SQL Editor to add sample data.

## Database Schema Details

### Column Definitions

| Column | Type | Description |
|--------|------|-------------|
| id | BIGINT | Primary key, auto-increment |
| name | TEXT | Transaction name/description |
| amount | NUMERIC | Transaction amount (positive/negative) |
| start_date | DATE | When transaction starts occurring |
| end_date | DATE | When transaction stops occurring |
| frequency | INTEGER | Recurrence interval (0 = one-time) |
| uom | TEXT | Unit of measure (day, week, month) |
| created_at | TIMESTAMP | Record creation time |
| updated_at | TIMESTAMP | Record last update time |

### Constraints

- `uom` must be one of: 'day', 'week', 'month'
- `start_date` must be <= `end_date`
- `frequency` >= 0
- `name` cannot be empty
- `amount` can be positive (income) or negative (expense)

## Backups

### Automatic Backups
In Supabase:
1. Go to Settings → Backups
2. Enable automatic daily backups
3. Keep 7 days of backups

### Manual Backups
```bash
# Export data
pg_dump -h [host] -U [user] -d [database] > backup.sql
```

## Monitoring

### View Logs
1. Supabase dashboard → Logs
2. See database operations in real-time

### Query Performance
1. Supabase dashboard → Database → Query Performance
2. Identify slow queries
3. Add indexes as needed

## Troubleshooting

### Connection Refused
- Check Project URL is correct
- Verify Anon Key is valid
- Check internet connection
- Ensure firewall allows connections

### RLS Prevents Access
- Check RLS policies allow operations
- Use public schema initially
- Verify user_id matches

### Data Not Showing
- Check table exists: `SELECT * FROM transactions;`
- Verify data inserted correctly
- Check browser DevTools Network tab

### Slow Queries
- Add indexes on frequently queried columns
- Check table size
- Use query optimization

## Advanced Configuration

### Enable Realtime

In Supabase:
1. Go to Realtime
2. Click "transactions"
3. Select events: INSERT, UPDATE, DELETE
4. Enable in your app:

```typescript
const channel = supabase
  .channel('transactions:*')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, (payload) => {
    console.log('Change received!', payload)
  })
  .subscribe()
```

### Custom Functions

Create PostgreSQL functions:

```sql
-- Function to get balance on specific date
CREATE FUNCTION get_balance_on_date(target_date DATE) RETURNS NUMERIC AS $$
  SELECT SUM(amount) 
  FROM transactions 
  WHERE start_date <= target_date AND end_date >= target_date;
$$ LANGUAGE SQL;
```

Use from React:
```typescript
const { data, error } = await supabase
  .rpc('get_balance_on_date', { target_date: '2026-01-15' })
```

## Security Checklist

- [ ] Changed default password
- [ ] Enabled 2FA on account
- [ ] Enabled RLS on tables
- [ ] Restricted Anon Key permissions
- [ ] Never committed Anon Key to git
- [ ] Set up backups
- [ ] Reviewed RLS policies
- [ ] Set up monitoring alerts

## Cost Management

### Free Tier Includes
- 500MB database storage
- 5GB bandwidth/month
- Unlimited API calls
- Unlimited database rows

### Upgrade Triggers
- Database > 500MB
- Bandwidth > 5GB/month
- Need custom domains
- Need priority support

### Monthly Cost Estimates
- **Free**: $0
- **Pro**: $10/month
- **Business**: $50/month

## Next Steps

1. ✅ Create Supabase project
2. ✅ Create transactions table
3. ✅ Enable RLS
4. ✅ Get API credentials
5. ✅ Update .env.local
6. ✅ Test connection
7. ✅ Add sample data
8. Deploy to Vercel (see VERCEL_DEPLOYMENT.md)

## Resources

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Docs](https://www.postgresql.org/docs)
- [RLS Policies Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Supabase CLI](https://supabase.com/docs/guides/cli)

## Support

- **Supabase Support**: [supabase.com/support](https://supabase.com/support)
- **Community**: [github.com/supabase/supabase/discussions](https://github.com/supabase/supabase/discussions)
- **Status Page**: [status.supabase.com](https://status.supabase.com)
